import React, { useEffect, useState, useRef } from "react";
import { useParams, Link } from "react-router-dom";
import { scanProject, reviseUpload, editPart, history } from "../api.js";
import { PencilSquareIcon, ArrowUpOnSquareIcon, ClockIcon, BoltIcon } from "@heroicons/react/24/outline";

const PartTypeBadge = ({t}) => <span className="badge badge-blue">{t}</span>;

export default function Project(){
  const { projectNumber, projectName } = useParams();
  const [parts, setParts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [editing, setEditing] = useState(null);

  const fileRef = useRef(null);
  const [uploadTarget, setUploadTarget] = useState(null);

  const [historyFor, setHistoryFor] = useState(null);
  const [historyData, setHistoryData] = useState(null);

  async function load(){
    setLoading(true);
    setError("");
    try{
      const sc = await scanProject(projectNumber, projectName);
      setParts(sc.parts||[]);
    }catch(e){
      console.error("scan error", e);
      setError("Could not load project parts");
    }finally{
      setLoading(false);
    }
  }
  useEffect(()=>{ load(); }, []);

  function openRevise(part){
    if(!part){ alert("No part to revise yet"); return; }
    console.log("[UI] Revise clicked for", part);
    setUploadTarget(part);
    fileRef.current?.click();
  }

  async function onChooseFile(e){
    const f = e.target.files?.[0];
    if(!f || !uploadTarget) return;
    console.log("[UI] File chosen", f.name, "for", uploadTarget);
    try{
      const res = await reviseUpload({
        file: f,
        projectNumber, projectName,
        typePrefix: uploadTarget.typePrefix,
        partNumber: uploadTarget.partNumber,
        description: uploadTarget.description || "Uploaded via UI",
        notes: "Uploaded via UI"
      });
      console.log("[UI] Upload ok", res);
      alert(`Revision added: ${res.nextRev}`);
      await load();
    }catch(err){
      console.error("[UI] Upload failed", err);
      alert("Upload failed");
    }finally{
      e.target.value = "";
      setUploadTarget(null);
    }
  }

  async function openHistory(part){
    console.log("[UI] History clicked for", part);
    setHistoryFor(part);
    setHistoryData(null);
    try{
      const h = await history({
        projectNumber, projectName,
        typePrefix: part.typePrefix,
        partNumber: part.partNumber
      });
      setHistoryData(h);
    }catch(err){
      console.error("history error", err);
      setHistoryData({ error:"Failed to load history" });
    }
  }

  async function onSaveEdit(form){
    await editPart({
      projectNumber, projectName,
      typePrefix: form.typePrefix,
      partNumber: form.partNumber,
      newTypePrefix: form.newTypePrefix,
      newDescription: form.newDescription,
      note: form.note || ""
    });
    setEditing(null);
    await load();
  }

  return (
    <div className="space-y-6">
      <input id="upload-global" ref={fileRef} type="file" className="hidden" onChange={onChooseFile} />

      <div className="flex items-center gap-3">
        <Link to="/" className="btn-ghost" type="button">Back to Projects</Link>
      </div>

      <div className="card p-6 flex items-start gap-4">
        <div className="h-12 w-12 rounded-xl bg-ink text-white grid place-items-center text-2xl">üìÅ</div>
        <div className="flex-1">
          <div className="flex items-center gap-3">
            <span className="text-xs text-slate-500">{projectNumber}</span>
            <span className="badge badge-green">active</span>
          </div>
          <h2 className="text-3xl font-extrabold tracking-tight">{projectName}</h2>
          <div className="text-xs text-slate-500 mt-1">Client release management</div>
        </div>
        <div className="flex items-center gap-2">
          <button type="button" className="btn" onClick={()=>openRevise(parts[0])}>Upload Files</button>
        </div>
      </div>

      <div className="card overflow-hidden">
        <div className="px-6 py-4 flex items-center justify-between">
          <div className="font-semibold">Parts & Files</div>
          <div className="text-xs badge badge-muted">{parts.length} parts</div>
        </div>
        <table className="table">
          <thead className="bg-slate-50">
            <tr>
              <th className="th">Type</th>
              <th className="th">Part #</th>
              <th className="th">Description</th>
              <th className="th">File</th>
              <th className="th">Rev</th>
              <th className="th">Notes</th>
              <th className="th">Source</th>
              <th className="th">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-200">
            {loading && <tr><td className="td" colSpan="8">Loading‚Ä¶</td></tr>}
            {!loading && parts.length===0 && <tr><td className="td" colSpan="8">No parts yet.</td></tr>}
            {parts.map(p => (
              <tr key={p.typePrefix + "-" + p.partNumber}>
                <td className="td"><PartTypeBadge t={p.typePrefix} /></td>
                <td className="td font-mono">{p.typePrefix}{p.partNumber.padStart(3,"0")}</td>
                <td className="td">{p.description || "‚Äî"}</td>
                <td className="td"><span className="badge badge-blue">STEP</span></td>
                <td className="td"><span className="badge badge-muted">{p.latestRev || "‚Äî"}</span></td>
                <td className="td text-slate-500">{p.notes || "Manual"}</td>
                <td className="td"><span className="badge badge-muted">Manual</span></td>
                <td className="td">
                  <div className="flex items-center gap-3">
                    <button type="button" className="text-green-700" title="Revise" onClick={()=>openRevise(p)}><ArrowUpOnSquareIcon className="h-5 w-5" /></button>
                    <button type="button" className="text-slate-700" title="Edit" onClick={()=>setEditing(p)}><PencilSquareIcon className="h-5 w-5" /></button>
                    <button type="button" className="text-slate-700" title="History" onClick={()=>openHistory(p)}><ClockIcon className="h-5 w-5" /></button>
                    <button type="button" className="text-orange-500" title="Release" onClick={()=>alert("Release coming soon")}><BoltIcon className="h-5 w-5" /></button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {editing && <EditModal p={editing} project={{projectNumber,projectName}} onClose={()=>setEditing(null)} onSave={onSaveEdit} />}

      {historyFor && (
        <div className="fixed inset-0 z-50 bg-black/20 grid place-items-center p-4" onClick={()=>setHistoryFor(null)}>
          <div className="card w-full max-w-2xl p-6" onClick={e=>e.stopPropagation()}>
            <div className="text-lg font-semibold mb-2">Revision History ‚Äì {historyFor.typePrefix}{historyFor.partNumber}</div>
            {!historyData && <div className="text-sm text-slate-600">Loading‚Ä¶</div>}
            {historyData?.error && <div className="text-sm text-red-600">{historyData.error}</div>}
            {historyData?.revisions && (
              <ul className="space-y-2 max-h-80 overflow-auto">
                {historyData.revisions.map(r => (
                  <li key={r.filename} className="flex items-center justify-between border rounded-lg px-3 py-2">
                    <div>
                      <div className="font-mono text-sm">{r.rev} ¬∑ {r.filename}</div>
                      <div className="text-xs text-slate-500">{r.mtime} ¬∑ {r.notes || "‚Äî"}</div>
                    </div>
                    <span className="badge badge-muted">{r.createdBy}</span>
                  </li>
                ))}
              </ul>
            )}
            <div className="mt-4 text-right">
              <button className="btn-ghost" type="button" onClick={()=>setHistoryFor(null)}>Close</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function EditModal({p, project, onClose, onSave}){
  const [desc,setDesc]=useState(p.description||"");
  const [type,setType]=useState(p.typePrefix);
  const [note,setNote]=useState("");

  async function save(){
    await onSave({
      typePrefix: p.typePrefix,
      partNumber: p.partNumber,
      newTypePrefix: type,
      newDescription: desc,
      note
    });
  }

  return (
    <div className="fixed inset-0 bg-black/20 grid place-items-center p-4">
      <div className="card w-full max-w-xl p-6">
        <div className="text-lg font-semibold mb-1">Edit Part</div>
        <div className="text-xs text-slate-500 mb-4">Update part details. Project and part numbers cannot be changed.</div>

        <div className="text-xs text-slate-600 mb-2">Part Number (read-only)</div>
        <div className="input mb-4 font-mono bg-slate-50">{project.projectNumber}_{p.typePrefix}{p.partNumber.padStart(3,"0")}</div>

        <label className="text-xs text-slate-600">Description</label>
        <input className="input mb-4" value={desc} onChange={e=>setDesc(e.target.value)} placeholder="Description" />

        <label className="text-xs text-slate-600">Part Type</label>
        <select className="select mb-4" value={type} onChange={e=>setType(e.target.value)}>
          <option value="P">Part (P)</option>
          <option value="A">Assembly (A)</option>
          <option value="H">Hardware (H)</option>
        </select>

        <label className="text-xs text-slate-600">Note</label>
        <input className="input mb-6" value={note} onChange={e=>setNote(e.target.value)} placeholder="Change note" />

        <div className="flex items-center justify-end gap-2">
          <button className="btn-ghost" type="button" onClick={onClose}>Cancel</button>
          <button className="btn" type="button" onClick={save}>Save Changes</button>
        </div>

        <div className="text-xs text-slate-500 mt-4">
          Current canonical filename will update after save and refresh.
        </div>
      </div>
    </div>
  );
}
