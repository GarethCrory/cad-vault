import React, { useEffect, useMemo, useRef, useState } from "react";
import { useParams, Link } from "react-router-dom";
import { scanProject, history, editPart } from "../api.js";
import { PencilSquareIcon, ArrowUpOnSquareIcon, ClockIcon, BoltIcon, ArrowUpTrayIcon, XMarkIcon } from "@heroicons/react/24/outline";

const PartTypeBadge = ({ t }) => (
  <span className="badge badge-blue">{t}</span>
);

export default function Project(){
  const { projectNumber, projectName } = useParams();
  const project = { projectNumber, projectName };

  const [parts, setParts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [editing, setEditing] = useState(null);
  const [showAdd, setShowAdd] = useState(false);

  const nextPartNumber = useMemo(()=>{
    let max = 0;
    (parts||[]).forEach(p=>{
      const n = parseInt(p.partNumber, 10) || 0;
      if(n > max) max = n;
    });
    return String(max + 1).padStart(3,"0");
  }, [parts]);

  async function load(){
    setLoading(true);
    setError("");
    try{
      const sc = await scanProject(projectNumber, projectName);
      setParts(sc.parts || []);
    }catch(e){
      setError("Could not load project parts");
    }finally{
      setLoading(false);
    }
  }

  useEffect(()=>{ load(); }, []);

  function openAdd(){ setShowAdd(true); }
  function closeAdd(){ setShowAdd(false); }

  async function onSaveEdit(form){
    await editPart({
      projectNumber, projectName,
      typePrefix: form.typePrefix,
      partNumber: form.partNumber,
      newTypePrefix: form.newTypePrefix,
      newDescription: form.newDescription,
      note: form.note||""
    });
    setEditing(null);
    await load();
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-3">
        <Link to="/" className="btn-ghost">Back to Projects</Link>
      </div>

      <div className="card p-6 flex items-start gap-4">
        <div className="h-12 w-12 rounded-xl bg-ink text-white grid place-items-center text-2xl">üìÅ</div>
        <div className="flex-1">
          <div className="flex items-center gap-3">
            <span className="text-xs text-slate-500">{projectNumber}</span>
            <span className="badge badge-green">active</span>
          </div>
          <h2 className="text-3xl font-extrabold tracking-tight">{projectName}</h2>
          <div className="text-xs text-slate-500 mt-1">Client release management</div>
        </div>
        <div className="flex items-center gap-2">
          <button className="btn btn-primary" onClick={openAdd}>
            <ArrowUpTrayIcon className="h-5 w-5" />
            Add File
          </button>
        </div>
      </div>

      <div className="card overflow-hidden">
        <div className="px-6 py-4 flex items-center justify-between">
          <div className="font-semibold">Parts & Files</div>
          <div className="text-xs badge badge-muted">{parts.length} parts</div>
        </div>
        <table className="table">
          <thead className="bg-slate-50">
            <tr>
              <th className="th">Type</th>
              <th className="th">Part #</th>
              <th className="th">Description</th>
              <th className="th">File</th>
              <th className="th">Rev</th>
              <th className="th">Notes</th>
              <th className="th">Source</th>
              <th className="th">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-200">
            {loading && (
              <tr><td className="td" colSpan="8">Loading‚Ä¶</td></tr>
            )}
            {!loading && parts.length===0 && (
              <tr><td className="td" colSpan="8">No parts yet.</td></tr>
            )}
            {parts.map(p => (
              <PartRow key={p.typePrefix+"-"+p.partNumber}
                p={p}
                projectNumber={projectNumber}
                projectName={projectName}
                onEdit={()=>setEditing(p)}
              />
            ))}
          </tbody>
        </table>
      </div>

      {editing && <EditModal p={editing} project={{projectNumber,projectName}} onClose={()=>setEditing(null)} onSave={onSaveEdit} />}
      {showAdd && (
        <AddFileModal
          project={project}
          defaultType="P"
          defaultPartNumber={nextPartNumber}
          onClose={closeAdd}
          onSaved={()=>{ closeAdd(); load(); }}
        />
      )}
    </div>
  );
}

function PartRow({p, projectNumber, projectName, onEdit}){
  const [latest,setLatest]=useState("");
  useEffect(()=>{
    history({ projectNumber, projectName, typePrefix:p.typePrefix, partNumber:p.partNumber })
      .then(h=>setLatest(h.latestRev||""))
      .catch(()=>setLatest(""));
  },[]);
  return (
    <tr>
      <td className="td"><PartTypeBadge t={p.typePrefix} /></td>
      <td className="td font-mono">{`${p.typePrefix}${p.partNumber.padStart(3,"0")}`}</td>
      <td className="td">{p.description||"‚Äî"}</td>
      <td className="td"><span className="badge badge-muted">STEP</span></td>
      <td className="td"><span className="badge badge-muted">{latest||"‚Äî"}</span></td>
      <td className="td text-slate-500">Manual</td>
      <td className="td"><span className="badge badge-muted">Manual</span></td>
      <td className="td">
        <div className="flex items-center gap-3">
          <button className="text-slate-700" title="Edit" onClick={onEdit}><PencilSquareIcon className="h-5 w-5" /></button>
          <button className="text-slate-700" title="History"><ClockIcon className="h-5 w-5" /></button>
          <button className="text-orange-500" title="Release"><BoltIcon className="h-5 w-5" /></button>
        </div>
      </td>
    </tr>
  );
}

function EditModal({p, project, onClose, onSave}){
  const [desc,setDesc]=useState(p.description||"");
  const [type,setType]=useState(p.typePrefix);
  const [note,setNote]=useState("");

  async function save(){
    await onSave({
      typePrefix: p.typePrefix,
      partNumber: p.partNumber,
      newTypePrefix: type,
      newDescription: desc,
      note
    });
  }

  return (
    <div className="fixed inset-0 bg-black/20 grid place-items-center p-4 z-50">
      <div className="card w-full max-w-xl p-6 relative">
        <button className="absolute right-4 top-4 text-slate-500" onClick={onClose}><XMarkIcon className="h-5 w-5" /></button>
        <div className="text-lg font-semibold mb-1">Edit Part</div>
        <div className="text-xs text-slate-500 mb-4">Update part details. Project and part numbers cannot be changed.</div>

        <div className="text-xs text-slate-600 mb-2">Part Number (read-only)</div>
        <div className="input mb-4 font-mono bg-slate-50">{project.projectNumber}_{p.typePrefix}{p.partNumber.padStart(3,"0")}</div>

        <label className="text-xs text-slate-600">Description</label>
        <input className="input mb-4" value={desc} onChange={e=>setDesc(e.target.value)} placeholder="Description" />

        <label className="text-xs text-slate-600">Part Type</label>
        <select className="select mb-4" value={type} onChange={e=>setType(e.target.value)}>
          <option value="P">Part (P)</option>
          <option value="A">Assembly (A)</option>
          <option value="H">Hardware (H)</option>
        </select>

        <label className="text-xs text-slate-600">Note</label>
        <input className="input mb-6" value={note} onChange={e=>setNote(e.target.value)} placeholder="Change note" />

        <div className="flex items-center justify-end gap-2">
          <button className="btn-ghost" onClick={onClose}>Cancel</button>
          <button className="btn" onClick={save}>Save Changes</button>
        </div>

        <div className="text-xs text-slate-500 mt-4">
          Current canonical filename will update after save and refresh.
        </div>
      </div>
    </div>
  );
}

function AddFileModal({ project, defaultType="P", defaultPartNumber="001", onClose, onSaved }){
  const [typePrefix, setTypePrefix] = useState(defaultType);
  const [partNumber, setPartNumber] = useState(defaultPartNumber);
  const [description, setDescription] = useState("");
  const [note, setNote] = useState("");
  const [busy, setBusy] = useState(false);
  const fileRef = useRef(null);

  async function submit(){
    if(busy) return;
    const file = fileRef.current?.files?.[0];
    if(!file) return;

    setBusy(true);
    try{
      const fd = new FormData();
      fd.append("file", file);
      fd.append("project", JSON.stringify({ projectNumber: project.projectNumber, projectName: project.projectName }));
      fd.append("typePrefix", typePrefix);
      fd.append("partNumber", partNumber);
      fd.append("rev", "RevA");
      fd.append("description", description||"");
      fd.append("notes", note||"Added via UI");

      const r = await fetch("http://localhost:4000/api/file/upload", { method:"POST", body: fd });
      if(!r.ok){
        const txt = await r.text();
        throw new Error(txt||"Upload failed");
      }
      await r.json(); // response not used here
      onSaved && onSaved();
    }catch(err){
      alert(err.message||String(err));
    }finally{
      setBusy(false);
    }
  }

  return (
    <div className="fixed inset-0 bg-black/20 grid place-items-center p-4 z-50">
      <div className="card w-full max-w-xl p-6 relative">
        <button className="absolute right-4 top-4 text-slate-500" onClick={onClose}><XMarkIcon className="h-5 w-5" /></button>
        <div className="text-lg font-semibold mb-1">Add File</div>
        <div className="text-xs text-slate-500 mb-4">Choose a STEP file and enter details. New parts start at RevA.</div>

        <label className="text-xs text-slate-600">Description</label>
        <input className="input mb-4" value={description} onChange={e=>setDescription(e.target.value)} placeholder="e.g. Base Plate" />

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="text-xs text-slate-600">Part Type</label>
            <select className="select mb-4" value={typePrefix} onChange={e=>setTypePrefix(e.target.value)}>
              <option value="P">Part (P)</option>
              <option value="A">Assembly (A)</option>
              <option value="H">Hardware (H)</option>
            </select>
          </div>
          <div>
            <label className="text-xs text-slate-600">Part Number</label>
            <input className="input mb-4 font-mono" value={partNumber} onChange={e=>setPartNumber(e.target.value.replace(/[^0-9]/g,"").padStart(3,"0"))} />
          </div>
        </div>

        <label className="text-xs text-slate-600">Note</label>
        <input className="input mb-4" value={note} onChange={e=>setNote(e.target.value)} placeholder="Optional note" />

        <label className="text-xs text-slate-600">File (.step)</label>
        <input type="file" accept=".step,.stp" ref={fileRef} className="mb-6" />

        <div className="flex items-center justify-end gap-2">
          <button className="btn-ghost" onClick={onClose}>Cancel</button>
          <button className="btn btn-primary" disabled={busy} onClick={submit}>
            <ArrowUpTrayIcon className="h-5 w-5" />
            {busy ? "Uploading‚Ä¶" : "Upload"}
          </button>
        </div>
      </div>
    </div>
  );
}
