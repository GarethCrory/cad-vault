import React, { useEffect, useMemo, useRef, useState } from "react";
import { useParams, Link } from "react-router-dom";
import { listProjects, scanProject, history, reviseUpload, editPart, generateRelease } from "../api.js";
import { PencilSquareIcon, ArrowUpOnSquareIcon, ClockIcon, PaperAirplaneIcon } from "@heroicons/react/24/outline";

const PartTypeBadge = ({t}) => <span className="badge badge-blue">{t}</span>;

export default function Project(){
  const { projectNumber, projectName } = useParams();
  const [parts, setParts] = useState([]);
  const [showAdd, setShowAdd] = useState(false);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [editing, setEditing] = useState(null);
  const [tab, setTab] = useState("files");

  const [createdAt, setCreatedAt] = useState(null);
  const [nextPart, setNextPart] = useState("001");
  const fileRef = useRef(null);

  async function load(){
    setLoading(true);
    setError("");
    try{
      const sc = await scanProject(projectNumber, projectName);
      setParts(sc.parts||[]);
      const lp = await listProjects();
      const me = (lp.projects||[]).find(p => p.projectNumber===projectNumber && p.projectName===projectName);
      if(me){
        setCreatedAt(me.createdAt);
        setNextPart(me.nextPartNumber||"001");
      }else{
        setCreatedAt(new Date().toISOString());
        setNextPart(String(((sc.parts||[]).length+1)).padStart(3,"0"));
      }
    }catch(e){
      setError("Could not load project");
    }finally{
      setLoading(false);
    }
  }
  useEffect(()=>{ load(); },[]);

  async function onUpload(p){
    const f = fileRef.current?.files?.[0];
    if(!f) return alert("Pick a file first");
    await reviseUpload({
      file:f, projectNumber, projectName,
      typePrefix:p.typePrefix, partNumber:p.partNumber,
      description: p.description||"", notes:"Uploaded via UI"
    });
    fileRef.current.value = "";
    await load();
    alert(`Revision added for ${p.typePrefix}${p.partNumber}`);
  }

  async function onSaveEdit(form){
    await editPart({
      projectNumber, projectName,
      typePrefix: form.typePrefix,
      partNumber: form.partNumber,
      newTypePrefix: form.newTypePrefix,
      newDescription: form.newDescription,
      note: form.note||""
    });
    setEditing(null);
    await load();
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <Link to="/" className="btn-ghost">Back to Projects</Link>
        <div className="flex items-center gap-2">
      {showAdd && (<AddFileModal project={project} onClose={()=>setShowAdd(false)} onSaved={()=>{ setShowAdd(false); refresh && refresh(); }} />)}
        </div>
      </div>

      <HeaderCard
        projectNumber={projectNumber}
        projectName={projectName}
        createdAt={createdAt}
        totalParts={parts.length}
        nextPart={nextPart}
      />

      <div className="tabbar">
        <button className={`tab ${tab==="files"?"tab-active":""}`} onClick={() => { const el = document.getElementById("upload"); if (el) el.click(); }}>Files & Parts</button>
        <button className={`tab ${tab==="release"?"tab-active":""}`} onClick={()=>setTab("release")}>Client Release</button>
      </div>

      {tab==="files" ? (
        <FilesPanel
          parts={parts}
          loading={loading}
          projectNumber={projectNumber}
          projectName={projectName}
          setEditing={setEditing}
          onUpload={onUpload}
          fileRef={fileRef}
        />
      ) : (
        <ReleasePanel
          parts={parts}
          projectNumber={projectNumber}
          projectName={projectName}
        />
      )}

      {editing && <EditModal p={editing} project={{projectNumber,projectName}} onClose={()=>setEditing(null)} onSave={onSaveEdit} />}
    </div>
  );
}

function HeaderCard({ projectNumber, projectName, createdAt, totalParts, nextPart }){
  return (
    <div className="card p-6">
      <div className="flex items-center gap-5">
        <div className="h-16 w-16 rounded-2xl bg-[var(--ink)] text-white grid place-items-center text-3xl">üìÅ</div>
        <div className="flex-1">
          <div className="flex items-center gap-3">
            <span className="rounded-xl bg-slate-100 px-3 py-1 text-sm font-semibold">{projectNumber}</span>
            <span className="badge badge-green">active</span>
          </div>
          <h2 className="text-3xl font-extrabold tracking-tight">{projectName}</h2>
          <div className="text-sm text-slate-500 mt-1">Created {createdAt ? new Date(createdAt).toLocaleDateString() : "‚Äî"}</div>
        </div>
        <div className="flex items-center gap-10">
          <div className="text-right">
            <div className="metric">{totalParts}</div>
            <div className="metric-sub">Total Parts</div>
          </div>
          <div className="text-right">
            <div className="metric text-[var(--accent)]">{nextPart}</div>
            <div className="metric-sub">Next Part #</div>
          </div>
        </div>
      </div>
    </div>
  );
}

function FilesPanel({ parts, loading, projectNumber, projectName, setEditing, onUpload, fileRef }){
  return (
    <div className="card overflow-hidden">
      <div className="px-6 py-4 flex items-center justify-between">
        <div className="font-semibold">Parts & Files</div>
        <div className="flex items-center gap-2">
          <button type="button" className="btn btn-primary" onClick={() => setShowAdd(true)}>Add File</button>
          <input id="upload" ref={fileRef} type="file" className="hidden" />
        </div>
      </div>
      <table className="table">
        <thead className="bg-slate-50">
          <tr>
            <th className="th">Type</th>
            <th className="th">Part #</th>
            <th className="th">Description</th>
            <th className="th">File</th>
            <th className="th">Rev</th>
            <th className="th">Notes</th>
            <th className="th">Source</th>
            <th className="th">Actions</th>
          </tr>
        </thead>
        <tbody className="divide-y divide-slate-200">
          {loading && <tr><td className="td" colSpan="8">Loading‚Ä¶</td></tr>}
          {!loading && parts.length===0 && <tr><td className="td" colSpan="8">No parts yet.</td></tr>}
          {parts.map(p => (
            <PartRow key={p.typePrefix+"-"+p.partNumber}
              p={p}
              projectNumber={projectNumber}
              projectName={projectName}
              onUpload={()=>onUpload(p)}
              onEdit={()=>setEditing(p)}
            />
          ))}
        </tbody>
      </table>
    </div>
  );
}

function PartRow({p, projectNumber, projectName, onUpload, onEdit}){
  const [latest,setLatest]=useState("");
  useEffect(()=>{
    history({ projectNumber, projectName, typePrefix:p.typePrefix, partNumber:p.partNumber })
      .then(h=>setLatest(h.latestRev||""))
      .catch(()=>setLatest(""));
  },[]);
  return (
    <tr>
      <td className="td"><PartTypeBadge t={p.typePrefix} /></td>
      <td className="td font-mono">{`${p.typePrefix}${p.partNumber.padStart(3,"0")}`}</td>
      <td className="td">{p.description||"‚Äî"}</td>
      <td className="td"><span className="badge badge-blue">STEP</span></td>
      <td className="td"><span className="badge badge-muted">{latest||"‚Äî"}</span></td>
      <td className="td text-slate-500">Manual</td>
      <td className="td"><span className="badge badge-muted">Manual</span></td>
      <td className="td">
        <div className="flex items-center gap-3">
          <button className="text-green-700" title="Revise" onClick={onUpload}><ArrowUpOnSquareIcon className="h-5 w-5" /></button>
          <button className="text-slate-700" title="Edit" onClick={onEdit}><PencilSquareIcon className="h-5 w-5" /></button>
          <HistoryButton projectNumber={projectNumber} projectName={projectName} p={p} />
        </div>
      </td>
    </tr>
  );
}

function HistoryButton({ projectNumber, projectName, p }){
  const [open,setOpen]=useState(false);
  const [items,setItems]=useState([]);
  async function load(){
    const h = await history({ projectNumber, projectName, typePrefix:p.typePrefix, partNumber:p.partNumber });
    setItems(h.revisions||[]);
  }
  return (
    <>
      <button className="text-slate-700" title="History" onClick={()=>{ setOpen(true); load(); }}>
        <ClockIcon className="h-5 w-5" />
      </button>
      {open && (
        <div className="fixed inset-0 bg-black/20 grid place-items-center p-4" onClick={()=>setOpen(false)}>
          <div className="card w-full max-w-2xl p-6" onClick={e=>e.stopPropagation()}>
            <div className="text-lg font-semibold mb-4">Revision History ‚Äì {p.typePrefix}{p.partNumber}</div>
            <div className="space-y-2 max-h-[60vh] overflow-auto">
              {items.map(it=>(
                <div key={it.rev} className="flex items-center justify-between gap-3 bg-slate-50 border border-slate-200 rounded-xl px-3 py-2">
                  <span className="badge badge-muted">{it.rev}</span>
                  <span className="flex-1 font-mono text-sm truncate">{it.filename}</span>
                  <span className="text-xs text-slate-500">{new Date(it.mtime).toLocaleString()}</span>
                </div>
              ))}
              {items.length===0 && <div className="text-sm text-slate-500">No entries.</div>}
            </div>
            <div className="mt-4 text-right">
              <button className="btn btn-primary" onClick={()=>setOpen(false)}>Close</button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}

function ReleasePanel({ parts, projectNumber, projectName }){
  const [tag,setTag]=useState(new Date().toISOString().slice(0,10));
  const [publishing,setPublishing]=useState(false);
  const [selected, setSelected] = useState({});
  const countSelected = useMemo(()=>Object.values(selected).filter(Boolean).length,[selected]);

  // map of partKey -> { latestRev, filename }
  const [meta,setMeta] = useState({});

  useEffect(()=>{
    let live = true;
    async function loadMeta(){
      const entries = await Promise.all((parts||[]).map(async p=>{
        try{
          const h = await history({ projectNumber, projectName, typePrefix:p.typePrefix, partNumber:p.partNumber });
          const latest = h.latestRev||"";
          const fname = (h.revisions&&h.revisions[0]?.filename)||"";
          return [`${p.typePrefix}${p.partNumber}`, {latestRev:latest, filename:fname}];
        }catch(_){ return [`${p.typePrefix}${p.partNumber}`, {latestRev:"", filename:""}]; }
      }));
      if(live){
        const m = {};
        entries.forEach(([k,v])=> m[k]=v);
        setMeta(m);
      }
    }
    loadMeta();
    return ()=>{ live=false; };
  },[projectNumber, projectName, parts]);

  function toggleAll(on){
    const next = {};
    (parts||[]).forEach(p => next[`${p.typePrefix}${p.partNumber}`]=on);
    setSelected(next);
  }

  async function publish(){
    if(countSelected===0) return;
    setPublishing(true);
    try{
      const chosen = (parts||[])
        .filter(p => selected[`${p.typePrefix}${p.partNumber}`])
        .map(p => ({ typePrefix:p.typePrefix, partNumber:p.partNumber }));
      // backend may ignore the list; sending anyway for future support
      const r = await generateRelease({ projectNumber, projectName, releaseTag: tag, parts: chosen });
      alert(`Release created:\n${r.zipPath || r.path || "(see server log)"}`);
    }catch(e){
      alert(e.message||"release failed");
    }finally{
      setPublishing(false);
    }
  }

  return (
    <div className="card p-6">
      {/* Title row */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <div className="h-10 w-10 rounded-xl bg-slate-900 text-white grid place-items-center">üì¶</div>
          <div>
            <div className="font-semibold">Configure Client Release</div>
            <div className="text-xs text-slate-500">Used in ZIP filename and directory structure</div>
          </div>
        </div>
        <div className="text-xs text-slate-600">{countSelected} of {(parts||[]).length} selected</div>
      </div>

      {/* Tag + select controls */}
      <div className="flex items-center gap-2 mb-4">
        <input className="input w-40" type="date" value={tag} onChange={e=>setTag(e.target.value)} />
        <div className="flex-1" />
        <button className="btn btn-light" onClick={()=>toggleAll(true)}>Select All</button>
        <button className="btn btn-light" onClick={()=>toggleAll(false)}>Deselect All</button>
      </div>

      {/* List */}
      <div className="divide-y divide-slate-200">
        {(parts||[]).map(p=>{
          const key = `${p.typePrefix}${p.partNumber}`;
          const m = meta[key]||{};
          return (
            <div key={key} className="py-4 flex items-start justify-between">
              <div className="flex items-start gap-3">
                <input type="checkbox" className="mt-1 h-4 w-4"
                  checked={!!selected[key]}
                  onChange={e=>setSelected(s=>({ ...s, [key]: e.target.checked }))}
                />
                <div>
                  <div className="text-sm font-medium">
                    {p.description || "Unnamed"}
                  </div>
                  <div className="mt-1 flex items-center gap-2 text-xs text-slate-600">
                    <span className="font-mono">{`${projectNumber}_${p.typePrefix}${p.partNumber.padStart(3,"0")}`}</span>
                    <span>‚Ä¢</span>
                    <span className="badge badge-muted">{m.latestRev || "Rev?"}</span>
                    <span>‚Ä¢</span>
                    <span className="badge badge-blue">STEP</span>
                  </div>
                  <div className="mt-2 inline-flex rounded-lg bg-slate-100 border border-slate-200 px-3 py-1 text-xs font-mono text-slate-700">
                    {m.filename || "latest file"}
                  </div>
                </div>
              </div>
              <span className="badge badge-blue self-center">CAD</span>
            </div>
          );
        })}
        {parts.length===0 && <div className="py-6 text-sm text-slate-500">No parts to release.</div>}
      </div>

      {/* Publish */}
      <div className="mt-6">
        <button
          className="btn btn-primary w-full justify-center disabled:opacity-60"
          onClick={publish}
          disabled={publishing || countSelected===0}
          title={countSelected===0 ? "Select at least one file" : ""}
        >
          <PaperAirplaneIcon className="h-5 w-5" />
          {publishing ? "Publishing..." : `Publish Release (${countSelected} files)`}
        </button>
      </div>
    </div>
  );
}

function EditModal({p, project, onClose, onSave}){
  const [desc,setDesc]=useState(p.description||"");
  const [type,setType]=useState(p.typePrefix);
  const [note,setNote]=useState("");

  async function save(){
    await onSave({
      typePrefix: p.typePrefix,
      partNumber: p.partNumber,
      newTypePrefix: type,
      newDescription: desc,
      note
    });
  }

  return (
    <div className="fixed inset-0 bg-black/20 grid place-items-center p-4">
      <div className="card w-full max-w-xl p-6">
        <div className="text-lg font-semibold mb-1">Edit Part</div>
        <div className="text-xs text-slate-500 mb-4">Update part details. Project and part numbers cannot be changed.</div>

        <div className="text-xs text-slate-600 mb-2">Part Number (read-only)</div>
        <div className="input mb-4 font-mono bg-slate-50">{project.projectNumber}_{p.typePrefix}{p.partNumber.padStart(3,"0")}</div>

        <label className="text-xs text-slate-600">Description</label>
        <input className="input mb-4" value={desc} onChange={e=>setDesc(e.target.value)} placeholder="Description" />

        <label className="text-xs text-slate-600">Part Type</label>
        <select className="select mb-4" value={type} onChange={e=>setType(e.target.value)}>
          <option value="P">Part (P)</option>
          <option value="A">Assembly (A)</option>
          <option value="H">Hardware (H)</option>
        </select>

        <label className="text-xs text-slate-600">Note</label>
        <input className="input mb-6" value={note} onChange={e=>setNote(e.target.value)} placeholder="Change note" />

        <div className="flex items-center justify-end gap-2">
          <button className="btn btn-light" onClick={onClose}>Cancel</button>
          <button className="btn btn-primary" onClick={save}>Save Changes</button>
        </div>
      </div>
    </div>
  );
}
